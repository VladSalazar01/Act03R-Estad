---
title: "Resolución Actividad 3-Grupal Máster Bioinformática UNIR (2025)"
author: "Yuli Del Cisne Giron Castillo\n

         Kelly Ailen Loja Chalen \n
         
         Carolina Jacqueline Panchana Torres \n
         
         Vladimir Oswaldo Salazar Córdova \n
         
         Cristhian Santiago Vasco Toapanta\n
        "
date: "2025-06-05"
output: html_document
---

```{r setup, include=FALSE}
library(readr)
library(readxl)
library(dplyr)
library(tidyr)
library(tidyverse)
library(psych)
library(moments)
library(nortest)
library(car)
library(ggplot2)
library(summarytools)
library(patchwork)
library(cowplot)
library(purrr)
library(gtsummary)
library(gtable)
library(egg)
library(psych)
library(factoextra)
library(magrittr)
library(kableExtra)
library(FactoMineR)
library(tidyverse)
library(stats)
library(pheatmap)
library(gt)
```


#1.  Abrir, explorar y preprocesar la base de datos:

```{r Procesar datos}

if (rstudioapi::isAvailable()) {
  knitr::opts_knit$set(root.dir = dirname(rstudioapi::getActiveDocumentContext()$path))
} else {
# establece el directorio de trabajo manualmente, por ejemplo:
  knitr::opts_knit$set(root.dir = getwd())
}
# Verificar la carpeta de trabajo actual
print(getwd())


datos <- read.csv("Dataset expresión genes.csv ", header = TRUE, sep = ",")
View(datos)
anyNA(datos)

#Filtrar las columnes de la expresion genica
genes <- datos %>% select(starts_with("AQ_"))

#Determinar la normalidad de los datos 
tabla_resultados <- tibble(
  Variable = character(),
  `Test utilizado` = character(),
  `Valor p` = numeric(),
  Interpretación = character()
)

for (gen in colnames(genes)) {
  valores <- genes[[gen]]
  valores <- valores[!is.na(valores)]
  
  if (length(valores) < 50) {
    test <- shapiro.test(valores)
    test_usado <- "Shapiro-Wilk"
  } else {
    test <- ad.test(valores)
    test_usado <- "Anderson-Darling"
  }
  
  valor_p <- round(test$p.value, 8)
  interpretacion <- ifelse(valor_p >= 0.05, "Distribución normal", "No distribución normal")
  
  tabla_resultados <- add_row(tabla_resultados,
                       Variable = gen,
               `Test utilizado` = test_usado,
                      `Valor p` = valor_p,
                 Interpretación = interpretacion)
}

tabla_gt <- tabla_resultados %>%
  gt() %>%
  tab_header(
    title = md("**Tabla 1.** Evaluación de la normalidad de la expresión génica")
  ) %>%
  tab_source_note(md("Valores p obtenidos mediante Shapiro-Wilk (N < 50) o Anderson-Darling (N ≥ 50)"))

# Mostrar tabla
tabla_gt


```

```{r PCA}

#Escalar los datos de expresion genica

genes_scaled <- scale(genes)

#Aplicar el PCA

pca_result <- prcomp(genes_scaled, center = TRUE, scale. = TRUE)

#obtencion de los componentes
genes$componente <- pca_result$x

#tabla de cargas por componete 1 y 2

componentes <- pca_result$rotation
comp1 <- componentes[, 1:2]
comp1 <- as.data.frame(comp1)
comp1

# datos propios de los componentes principales
get_eigenvalue(pca_result)

# Visualizar varianza explicada
fviz_eig(pca_result, addlabels = TRUE, ylim = c(0, 40))

```

#2. Aplicar el PCA
```{r PCA}

#Escalar los datos de expresion genica

genes_scaled <- scale(genes)

#Calcular el PCA
pca_result <- prcomp(genes_scaled, center = TRUE, scale. = TRUE)

#Extraer los componentes
pca_df <- data.frame(pca_result$x)

#Obtener los eigenvalues
library(factoextra)
eigenvalues <- get_eigenvalue(pca_result)
eigenvalues

#Extraer las varianzas de los componenetes
varianzas <- pca_result$sdev^2

#Calcular la varianza total
total_varianza <- sum(varianzas)

#Varianza explicada por cada componente
varianza_explicada <- varianzas / total_varianza

#Varianza acumulara
varianza_acumulada <- cumsum(varianza_explicada)

#Mostrar tabla de varianzas
tabla_varianza <- data.frame(
  Componente = 1: length(varianza_explicada), 
  Varianza_Explicada = round(varianza_explicada * 100, 2),
  Varianza_Acumulada = round(varianza_acumulada * 100, 2)
)

tabla_varianza

#Determinar cuántos componentes explican por lo menos el 70% de la varianza
n.pc <- min(which(varianza_acumulada > 0.7 ))
paste("Se necesita", n.pc, "Componentes para explicar el 70% de la varianza")

fviz_eig(pca_result, addlabels = TRUE, ylim = c(0, 40))

#Extraer resultados de los individuos
ind <- get_pca_ind(pca_result)
head(ind$coord)

#Extraer resultados de las variables
var <- get_pca_var(pca_result)
head(var$coord)

#Visualizar importancia de cada variable en PC1 y PC2
fviz_cos2(pca_result, choice = "var", axes = 1:2)
#Visualizar variabls mas importantes en PC1
fviz_contrib(pca_result, choice = "var", axes = 1,top = 10 )
#Etiquetas de los ejes para el gráfico de dispersion

x_label <- paste0("PC1 (", round(varianza_explicada[1] * 100, 2), "%)")
y_label <- paste0("PC2 (", round(varianza_explicada[2] * 100, 2), "%)")

#Genrar grafico de dispersion de los dos primeros componentes

ggplot(pca_df, aes(x=PC1, y=PC2))+
  geom_point(size = 3, color = "steelblue") +
  labs(title = "PCA - Expresión Genética", x = x_label, y = y_label)+
  theme_classic() +
  theme(panel.grid.major = element_line(color = "gray90"),
        panel.background = element_rect(fill = "gray95"),
        plot.title = element_text(hjust = 0.5))

#Carga de los dos primeros componentes
cargas<- as.data.frame(pca_result$rotation[, 1:3])
cargas

```

